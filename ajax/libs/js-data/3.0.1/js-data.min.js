/*!
* js-data
* @version 3.0.1 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t(e.JSData=e.JSData||{})}(this,function(e){"use strict";function Settable(){var e={};Object.defineProperties(this,{_get:{value:function value(t){return d.get(e,t)}},_set:{value:function value(t,n){return d.set(e,t,n)}},_unset:{value:function value(t){return d.unset(e,t)}}})}function Component(e){Settable.call(this),e||(e={}),this.debug=!!e.hasOwnProperty("debug")&&!!e.debug,Object.defineProperty(this,"_listeners",{value:{},writable:!0})}function Query(e){d.classCallCheck(this,Query),this.collection=e,this.data=null}function Relation(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};d.classCallCheck(this,Relation),n.type=this.constructor.TYPE_NAME,this.validateOptions(e,n),"object"===(void 0===e?"undefined":t(e))&&Object.defineProperty(this,"relatedMapper",{value:e}),Object.defineProperty(this,"inverse",{writable:!0}),d.fillIn(this,n)}function Record(e,t){d.classCallCheck(this,Record),Settable.call(this),e||(e={}),t||(t={});var n=this._set,i=this.constructor.mapper;n(k,!0),n(I,!!t.noValidate),n(F,void 0===t.keepChangeHistory?!i||i.keepChangeHistory:t.keepChangeHistory);var r=i?d.get(e,i.idAttribute):void 0;void 0!==r&&d.set(this,i.idAttribute,r),d.fillIn(this,e),n(k,!1),void 0!==t.validateOnSet?n(I,!t.validateOnSet):i&&void 0!==i.validateOnSet?n(I,!i.validateOnSet):n(I,!1),n(E,i?i.toJSON(e):d.plainCopy(e))}function sort(e,t,n){return e===t?0:(n&&(e=n(e),t=n(t)),null===e&&null===t||void 0===e&&void 0===t?-1:null===e||void 0===e?-1:null===t||void 0===t?1:e<t?-1:e>t?1:0)}function insertAt(e,t,n){return e.splice(t,0,n),e}function removeAt(e,t){return e.splice(t,1),e}function binarySearch(e,t,n){for(var i=0,r=e.length,o=void 0,a=void 0;i<r;){if(a=(i+r)/2|0,0===(o=sort(t,e[a],n)))return{found:!0,index:a};o<0?r=a:i=a+1}return{found:!1,index:r}}function Index(e,t){if(d.classCallCheck(this,Index),e||(e=[]),!d.isArray(e))throw new Error("fieldList must be an array.");t||(t={}),this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}function Collection(e,t){d.classCallCheck(this,Collection),p.call(this,t),e&&!d.isArray(e)&&(t=e,e=[]),d.isString(t)&&(t={idAttribute:t}),e||(e=[]),t||(t={}),Object.defineProperties(this,{mapper:{value:void 0,writable:!0},queryClass:{value:void 0,writable:!0}}),d.fillIn(this,t),d.fillIn(this,d.copy(P)),this.queryClass||(this.queryClass=O);var n=this.recordId();Object.defineProperties(this,{index:{value:new Index([n],{hashCode:function hashCode(e){return d.get(e,n)}})},indexes:{value:{}}}),(d.isObject(e)||d.isArray(e)&&e.length)&&this.add(e)}function Schema(e){var t=this;e||(e={}),d.fillIn(this,e),"object"===this.type?(this.properties=this.properties||{},d.forOwn(this.properties,function(e,n){e instanceof Schema||(t.properties[n]=new Schema(e))})):"array"!==this.type||!this.items||this.items instanceof Schema||(this.items=new Schema(this.items)),!this.extends||this.extends instanceof Schema||(this.extends=new Schema(this.extends)),["allOf","anyOf","oneOf"].forEach(function(e){t[e]&&t[e].forEach(function(n,i){n instanceof Schema||(t[e][i]=new Schema(n))})})}function Mapper(e){if(d.classCallCheck(this,Mapper),p.call(this),e||(e={}),Object.defineProperties(this,{_adapters:{value:void 0,writable:!0},datastore:{value:void 0,writable:!0},lifecycleMethods:{value:oe},recordClass:{value:void 0,writable:!0},schema:{value:void 0,writable:!0}}),d.fillIn(this,e),d.fillIn(this,d.copy(ae)),!this.name)throw d.err("new "+Z,"opts.name")(400,"string",this.name);if(this.schema&&(this.schema.type||(this.schema.type="object"),this.schema instanceof X||(this.schema=new X(this.schema||{type:"object"}))),void 0===this.recordClass){var t=j;this.recordClass=t.extend({constructor:function Record(){var e=function Record(n,i){d.classCallCheck(this,e),t.call(this,n,i)};return e}()})}this.recordClass&&(this.recordClass.mapper=this,d.isObject(this.methods)&&d.addHiddenPropsToTarget(this.recordClass.prototype,this.methods),j.prototype.isPrototypeOf(Object.create(this.recordClass.prototype))&&this.schema&&this.schema.apply&&this.applySchema&&this.schema.apply(this.recordClass.prototype))}function Container(e){d.classCallCheck(this,Container),p.call(this),e||(e={}),Object.defineProperties(this,{_adapters:{value:{}},_mappers:{value:{}},mapperClass:{value:void 0,writable:!0}}),d.fillIn(this,e),this.mapperDefaults=this.mapperDefaults||{},this.mapperClass||(this.mapperClass=se)}function SimpleStore(e){d.classCallCheck(this,SimpleStore),e||(e={}),d.fillIn(e,he),Container.call(this,e),this.collectionClass=this.collectionClass||M,this._collections={},this._pendingQueries={},this._completedQueries={}}function LinkedCollection(e,t){if(d.classCallCheck(this,LinkedCollection),Object.defineProperties(this,{_added:{value:{}},datastore:{writable:!0,value:void 0}}),M.call(this,e,t),!this.datastore)throw d.err("new "+ge,"opts.datastore")(400,"DataStore",this.datastore)}function DataStore(e){d.classCallCheck(this,DataStore),e||(e={}),d.fillIn(e,me),e.collectionClass||(e.collectionClass=ye),ve.call(this,e)}var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},i=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},r=Object.prototype.toString,o=/^(.+)\.(.+)$/,a={400:function _(){return"expected: "+arguments[0]+", found: "+(arguments[2]?arguments[1]:t(arguments[1]))},404:function _(){return arguments[0]+" not found"}},s=function toInteger(e){if(!e)return 0;if((e=+e)===1/0||e===-1/0)return 1.7976931348623157e308*(e<0?-1:1);var t=e%1;return e===e?t?e-t:e:0},c=function toStr(e){return r.call(e)},l=function isPlainObject(e){return!!e&&"object"===(void 0===e?"undefined":t(e))&&e.constructor===Object},u=function mkdirP(e,t){return t?(t.split(".").forEach(function(t){e[t]||(e[t]={}),e=e[t]}),e):e},d={Promise:Promise,_:function _(e,t){d.forOwn(t,function(t,n){n&&void 0===e[n]&&!d.isFunction(t)&&0!==n.indexOf("_")&&(e[n]=t)})},_forRelation:function _forRelation(e,t,n,i){var r=t.relation,o=null,a=void 0;if(e||(e={}),e.with||(e.with=[]),(a=d._getIndex(e.with,r))>=0?o=r:(a=d._getIndex(e.with,t.localField))>=0&&(o=t.localField),e.withAll)n.call(i,t,{});else if(o){var s={};d.fillIn(s,t.getRelation()),d.fillIn(s,e),s.with=e.with.slice(),s._activeWith=s.with.splice(a,1)[0],s.with.forEach(function(e,t){e&&0===e.indexOf(o)&&e.length>=o.length&&"."===e[o.length]?s.with[t]=e.substr(o.length+1):s.with[t]=""}),n.call(i,t,s)}},_getIndex:function _getIndex(e,t){var n=-1;return e.forEach(function(e,i){return e===t?(n=i,!1):d.isObject(e)&&e.relation===t?(n=i,!1):void 0}),n},addHiddenPropsToTarget:function addHiddenPropsToTarget(e,t){var n={};Object.keys(t).forEach(function(e){var i=Object.getOwnPropertyDescriptor(t,e);i.enumerable=!1,n[e]=i}),Object.defineProperties(e,n)},areDifferent:function areDifferent(e,t,n){n||(n={});var i=d.diffObjects(e,t,n);return Object.keys(i.added).length+Object.keys(i.removed).length+Object.keys(i.changed).length>0},classCallCheck:function classCallCheck$$1(e,t){if(!(e instanceof t))throw d.err(""+t.name)(500,"Cannot call a class as a function")},copy:function copy(e,t,n,i,r,o){if(t){if(e===t)throw d.err("utils.copy")(500,"Cannot copy! Source and destination are identical.");if(n=n||[],i=i||[],d.isObject(e)){var a=n.indexOf(e);if(-1!==a)return i[a];n.push(e),i.push(t)}var s=void 0;if(d.isArray(e)){var c=void 0;for(t.length=0,c=0;c<e.length;c++)s=d.copy(e[c],null,n,i,r,o),d.isObject(e[c])&&(n.push(e[c]),i.push(s)),t.push(s)}else{d.isArray(t)?t.length=0:d.forOwn(t,function(e,n){delete t[n]});for(var l in e)if(e.hasOwnProperty(l)){if(d.isBlacklisted(l,r))continue;s=d.copy(e[l],null,n,i,r,o),d.isObject(e[l])&&(n.push(e[l]),i.push(s)),t[l]=s}}}else t=e,e&&(d.isArray(e)?t=d.copy(e,[],n,i,r,o):d.isDate(e)?t=new Date(e.getTime()):d.isRegExp(e)?(t=new RegExp(e.source,e.toString().match(/[^/]*$/)[0])).lastIndex=e.lastIndex:d.isObject(e)&&(t=o?d.copy(e,{},n,i,r,o):d.copy(e,Object.create(Object.getPrototypeOf(e)),n,i,r,o)));return t},deepFillIn:function deepFillIn(e,t){return t&&d.forOwn(t,function(t,n){var i=e[n];l(t)&&l(i)?d.deepFillIn(i,t):e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)}),e},deepMixIn:function deepMixIn(e,t){if(t)for(var n in t){var i=t[n],r=e[n];l(i)&&l(r)?d.deepMixIn(r,i):e[n]=i}return e},diffObjects:function diffObjects(e,t,n){n||(n={});var i=n.equalsFn,r=n.ignore,o={added:{},changed:{},removed:{}};d.isFunction(i)||(i=d.deepEqual);var a=Object.keys(e).filter(function(e){return!d.isBlacklisted(e,r)}),s=Object.keys(t).filter(function(e){return!d.isBlacklisted(e,r)});return a.forEach(function(n){var r=t[n],a=e[n];i(r,a)||(void 0===r?o.added[n]=a:o.changed[n]=a)}),s.forEach(function(n){var i=t[n];void 0===e[n]&&void 0!==i&&(o.removed[n]=void 0)}),o},equal:function equal(e,t){return e==t},err:function err(e,t){return function(n){var i="["+e+":"+t+"] ",r=a[n].apply(null,Array.prototype.slice.call(arguments,1));return r=""+i+r+"\nhttp://www.js-data.io/v3.0/docs/errors#"+n,new Error(r)}},eventify:function eventify(e,t,n){e=e||this;var i={};t||n||(t=function getter(){return i},n=function setter(e){i=e}),Object.defineProperties(e,{emit:{value:function value(){for(var e=t.call(this)||{},n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];var o=i.shift(),a=e[o]||[],s=void 0;for(s=0;s<a.length;s++)a[s].f.apply(a[s].c,i);for(a=e.all||[],i.unshift(o),s=0;s<a.length;s++)a[s].f.apply(a[s].c,i)}},off:{value:function value(e,i){var r=t.call(this)[e];if(r)if(i){for(var o=0;o<r.length;o++)if(r[o].f===i){r.splice(o,1);break}}else r.splice(0,r.length);else n.call(this,{})}},on:{value:function value(e,i,r){t.call(this)||n.call(this,{});var o=t.call(this);o[e]=o[e]||[],o[e].push({c:r,f:i})}}})},extend:function extend(e,t){var n=this,i=void 0;e||(e={}),t||(t={}),e.hasOwnProperty("constructor")?(i=e.constructor,delete e.constructor):i=function subClass(){d.classCallCheck(this,i);for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];n.apply(this,t)},i.prototype=Object.create(n&&n.prototype,{constructor:{configurable:!0,enumerable:!1,value:i,writable:!0}});var r=Object;return r.setPrototypeOf?r.setPrototypeOf(i,n):t.strictEs6Class?i.__proto__=n:d.forOwn(n,function(e,t){i[t]=e}),i.hasOwnProperty("__super__")||Object.defineProperty(i,"__super__",{configurable:!0,value:n}),d.addHiddenPropsToTarget(i.prototype,e),d.fillIn(i,t),i},fillIn:function fillIn(e,t){d.forOwn(t,function(t,n){e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)})},findIndex:function findIndex(e,t){var n=-1;return e?(e.forEach(function(e,i){if(t(e))return n=i,!1}),n):n},forEachRelation:function forEachRelation(e,t,n,i){var r=e.relationList||[];r.length&&r.forEach(function(e){d._forRelation(t,e,n,i)})},forOwn:function forOwn(e,t,n){var i=Object.keys(e),r=i.length,o=void 0;for(o=0;o<r&&!1!==t.call(n,e[i[o]],i[o],e);o++);},fromJson:function fromJson(e){return d.isString(e)?JSON.parse(e):e},get:function get$$1(e,t){if(t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(null==(e=e[t]))return;return e[i]}},getSuper:function getSuper(e,t){var n=t?e:e.constructor;return n.hasOwnProperty("__super__")?n.__super__:Object.getPrototypeOf(n)||n.__proto__},intersection:function intersection(e,t){if(!e||!t)return[];var n=[],i=void 0,r=void 0,o=e.length;for(r=0;r<o;r++)i=e[r],-1===n.indexOf(i)&&-1!==t.indexOf(i)&&n.push(i);return n},isArray:Array.isArray,isBlacklisted:function isBlacklisted(e,t){if(!t||!t.length)return!1;for(var n=void 0,i=0;i<t.length;i++)if("[object RegExp]"===c(t[i])&&t[i].test(e)||t[i]===e)return!!(n=e);return!!n},isBoolean:function isBoolean(e){return"[object Boolean]"===c(e)},isDate:function isDate(e){return e&&"object"===(void 0===e?"undefined":t(e))&&"[object Date]"===c(e)},isFunction:function isFunction(e){return"function"==typeof e||e&&"[object Function]"===c(e)},isInteger:function isInteger(e){return"[object Number]"===c(e)&&e==s(e)},isNull:function isNull(e){return null===e},isNumber:function isNumber(e){var n=void 0===e?"undefined":t(e);return"number"===n||e&&"object"===n&&"[object Number]"===c(e)},isObject:function isObject(e){return"[object Object]"===c(e)},isRegExp:function isRegExp(e){return"[object RegExp]"===c(e)},isSorN:function isSorN(e){return d.isString(e)||d.isNumber(e)},isString:function isString(e){return"string"==typeof e||e&&"object"===(void 0===e?"undefined":t(e))&&"[object String]"===c(e)},isUndefined:function isUndefined(e){return void 0===e},logify:function logify(e){d.addHiddenPropsToTarget(e,{dbg:function dbg(){if(d.isFunction(this.log)){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))}},log:function log(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var r=e.toUpperCase()+": ("+(this.name||this.constructor.name)+")";if(d.isFunction(console[e])){var o;(o=console)[e].apply(o,[r].concat(n))}else{var a;(a=console).log.apply(a,[r].concat(n))}}}})},noDupeAdd:function noDupeAdd(e,t,n){e&&this.findIndex(e,n)<0&&e.push(t)},omit:function omit(e,t){var n={};return d.forOwn(e,function(e,i){-1===t.indexOf(i)&&(n[i]=e)}),n},pick:function pick(e,t){return t.reduce(function(t,n){return t[n]=e[n],t},{})},plainCopy:function plainCopy(e){return d.copy(e,void 0,void 0,void 0,void 0,!0)},reject:function reject(e){return d.Promise.reject(e)},remove:function remove(e,t){if(e&&e.length){var n=this.findIndex(e,t);n>=0&&e.splice(n,1)}},resolve:function resolve(e){return d.Promise.resolve(e)},set:function set$$1(e,t,n){if(d.isObject(t))d.forOwn(t,function(t,n){d.set(e,n,t)});else{var i=o.exec(t);i?u(e,i[1])[i[2]]=n:e[t]=n}},deepEqual:function deepEqual(e,t){if(e===t)return!0;var n=!0;if(d.isArray(e)&&d.isArray(t)){if(e.length!==t.length)return!1;for(var i=e.length;i--;)if(!d.deepEqual(e[i],t[i]))return!1}else{if(!d.isObject(e)||!d.isObject(t))return!1;d.forOwn(e,function(e,i){if(!(n=d.deepEqual(e,t[i])))return!1}),n&&d.forOwn(t,function(t,i){if(!(n=d.deepEqual(t,e[i])))return!1})}return n},toJson:JSON.stringify,unset:function unset(e,t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(null==(e=e[t]))return;e[i]=void 0}},f=function safeSetProp(e,t,n){e&&e._set?e._set("props."+t,n):d.set(e,t,n)},h=function safeSetLink(e,t,n){e&&e._set?e._set("links."+t,n):d.set(e,t,n)};Settable.extend=d.extend;var p=Settable.extend({constructor:Component});Component.extend=d.extend,d.logify(Component.prototype),d.eventify(Component.prototype,function(){return this._listeners},function(e){this._listeners=e});var v="Index inaccessible after first operation",g={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},y=/([.*+?^=!:${}()|[\]/\\])/g,m=/%/g,A=/_/g,b=function escape(e){return e.replace(y,"\\$1")},O=p.extend({constructor:Query,_applyWhereFromObject:function _applyWhereFromObject(e){var t=[],n=[],i=[];return d.forOwn(e,function(e,r){d.isObject(e)||(e={"==":e}),d.forOwn(e,function(e,o){t.push(r),n.push(o),i.push(e)})}),{fields:t,ops:n,predicates:i}},_applyWhereFromArray:function _applyWhereFromArray(e){var t=this,n=[];return e.forEach(function(i,r){if(!d.isString(i)){var o=e[r-1],a=(d.isArray(i)?t._applyWhereFromArray:t._applyWhereFromObject).call(t,i);"or"===o&&(a.isOr=!0),n.push(a)}}),n.isArray=!0,n},_testObjectGroup:function _testObjectGroup(e,t,n,i){var r=void 0,o=n.fields,a=n.ops,s=n.predicates,c=a.length;for(r=0;r<c;r++){var l=a[r],u="|"===l.charAt(0);l=u?l.substr(1):l;var f=this.evaluate(d.get(i,o[r]),l,s[r]);void 0!==f&&(e=t?f:u?e||f:e&&f),t=!1}return{keep:e,first:t}},_testArrayGroup:function _testArrayGroup(e,t,n,i){var r=void 0,o=n.length;for(r=0;r<o;r++){var a=n[r],s=(a.isArray?this._testArrayGroup:this._testObjectGroup).call(this,!0,!0,a,i);e=n[r-1]?a.isOr?e||s.keep:e&&s.keep:s.keep,t=s.first}return{keep:e,first:t}},between:function between(e,t,n){if(n||(n={}),this.data)throw d.err("Query#between")(500,"Cannot access index");return this.data=this.collection.getIndex(n.index).between(e,t,n),this},compare:function compare(e,t,n,i){var r=e[t],o=d.get(n,r[0]),a=d.get(i,r[0]);if(o&&d.isString(o)&&(o=o.toUpperCase()),a&&d.isString(a)&&(a=a.toUpperCase()),void 0===n&&(n=null),void 0===i&&(i=null),"DESC"===r[1].toUpperCase()){var s=a;a=o,o=s}return o<a?-1:o>a?1:t<e.length-1?this.compare(e,t+1,n,i):0},evaluate:function evaluate(e,t,n){var i=this.constructor.ops;return i[t]?i[t](e,n):0===t.indexOf("like")?null!==this.like(n,t.substr(4)).exec(e):0===t.indexOf("notLike")?null===this.like(n,t.substr(7)).exec(e):void 0},filter:function filter(e,t){var n=this;if(e||(e={}),this.getData(),d.isObject(e)){var i={};(d.isObject(e.where)||d.isArray(e.where))&&(i=e.where),d.forOwn(e,function(e,t){t in g||t in i||(i[t]={"==":e})});var r=void 0;d.isObject(i)&&0!==Object.keys(i).length?r=this._applyWhereFromArray([i]):d.isArray(i)&&(r=this._applyWhereFromArray(i)),r&&(this.data=this.data.filter(function(e,t){return n._testArrayGroup(!0,!0,r,e).keep}));var o=e.orderBy||e.sort;if(d.isString(o)&&(o=[[o,"ASC"]]),d.isArray(o)||(o=null),o){o.forEach(function(e,t){d.isString(e)&&(o[t]=[e,"ASC"])}),this.data.sort(function(e,t){return n.compare(o,0,e,t)})}d.isNumber(e.skip)?this.skip(e.skip):d.isNumber(e.offset)&&this.skip(e.offset),d.isNumber(e.limit)&&this.limit(e.limit)}else d.isFunction(e)&&(this.data=this.data.filter(e,t));return this},forEach:function forEach(e,t){return this.getData().forEach(e,t),this},get:function get(e,t){if(e||(e=[]),t||(t={}),this.data)throw d.err("Query#get")(500,v);return e&&!d.isArray(e)&&(e=[e]),e.length?(this.data=this.collection.getIndex(t.index).get(e),this):(this.getData(),this)},getAll:function getAll(){var e=this,t={};if(this.data)throw d.err("Query#getAll")(500,v);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];if(!i.length||1===i.length&&d.isObject(i[0]))return this.getData(),this;i.length&&d.isObject(i[i.length-1])&&(t=i[i.length-1],i.pop());var o=this.collection.getIndex(t.index);return this.data=[],i.forEach(function(t){e.data=e.data.concat(o.get(t))}),this},getData:function getData(){return this.data||(this.data=this.collection.index.getAll()),this.data},like:function like(e,t){return new RegExp("^"+b(e).replace(m,".*").replace(A,".")+"$",t)},limit:function limit(e){if(!d.isNumber(e))throw d.err("Query#limit","num")(400,"number",e);var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this},map:function map(e,t){return this.data=this.getData().map(e,t),this},mapCall:function mapCall(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.data=this.getData().map(function(t){return t[e].apply(t,n)}),this},run:function run(){var e=this.data;return this.data=null,e},skip:function skip(e){if(!d.isNumber(e))throw d.err("Query#skip","num")(400,"number",e);var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this}},{ops:{"=":function _(e,t){return e==t},"==":function _(e,t){return e==t},"===":function _(e,t){return e===t},"!=":function _(e,t){return e!=t},"!==":function _(e,t){return e!==t},">":function _(e,t){return e>t},">=":function _(e,t){return e>=t},"<":function _(e,t){return e<t},"<=":function _(e,t){return e<=t},isectEmpty:function isectEmpty(e,t){return!d.intersection(e||[],t||[]).length},isectNotEmpty:function isectNotEmpty(e,t){return d.intersection(e||[],t||[]).length},in:function _in(e,t){return-1!==t.indexOf(e)},notIn:function notIn(e,t){return-1===t.indexOf(e)},contains:function contains(e,t){return-1!==(e||[]).indexOf(t)},notContains:function notContains(e,t){return-1===(e||[]).indexOf(t)}}});Relation.extend=d.extend,d.addHiddenPropsToTarget(Relation.prototype,{get canAutoAddLinks(){return void 0===this.add||!!this.add},get relatedCollection(){return this.mapper.datastore.getCollection(this.relation)},validateOptions:function validateOptions(e,t){var n=t.localField;if(!n)throw d.err("new Relation","opts.localField")(400,"string",n);var i=t.foreignKey=t.foreignKey||t.localKey;if(!i&&("belongsTo"===t.type||"hasOne"===t.type))throw d.err("new Relation","opts.foreignKey")(400,"string",i);if(d.isString(e)){if(t.relation=e,!d.isFunction(t.getRelation))throw d.err("new Relation","opts.getRelation")(400,"function",t.getRelation)}else{if(!e)throw d.err("new Relation","related")(400,"Mapper or string",e);t.relation=e.name}},assignTo:function assignTo(e){this.name=e.name,Object.defineProperty(this,"mapper",{value:e}),e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(this),e.relationFields.push(this.localField)},canFindLinkFor:function canFindLinkFor(){return!(!this.foreignKey&&!this.localKey)},getRelation:function getRelation(){return this.relatedMapper},getForeignKey:function getForeignKey(e){return d.get(e,this.mapper.idAttribute)},setForeignKey:function setForeignKey(e,t){e&&t&&this._setForeignKey(e,t)},_setForeignKey:function _setForeignKey(e,t){var n=this,i=this.mapper.idAttribute;d.isArray(t)||(t=[t]),t.forEach(function(t){d.set(t,n.foreignKey,d.get(e,i))})},getLocalField:function getLocalField(e){return d.get(e,this.localField)},setLocalField:function setLocalField(e,t){return d.set(e,this.localField,t)},getInverse:function getInverse(e){return this.inverse||this.findInverseRelation(e),this.inverse},findInverseRelation:function findInverseRelation(e){var t=this;this.getRelation().relationList.forEach(function(n){if(n.getRelation()===e&&t.isInversedTo(n)&&t!==n)return t.inverse=n,!0})},isInversedTo:function isInversedTo(e){return!e.foreignKey||e.foreignKey===this.foreignKey},addLinkedRecords:function addLinkedRecords(e){var t=this,n=this.mapper.datastore;e.forEach(function(e){var i=t.getLocalField(e);d.isFunction(t.add)?i=t.add(n,t,e):i&&(i=t.linkRecord(e,i)),(!i||d.isArray(i)&&!i.length)&&t.canFindLinkFor(e)&&(i=t.findExistingLinksFor(e)),i&&t.setLocalField(e,i)})},removeLinkedRecords:function removeLinkedRecords(e,t){var n=this.localField;t.forEach(function(e){d.set(e,n,void 0)})},linkRecord:function linkRecord(e,t){var n=d.get(t,this.mapper.idAttribute);return void 0===n?-1===this.relatedCollection.unsaved().indexOf(t)&&this.canAutoAddLinks&&(t=this.relatedCollection.add(t)):t!==this.relatedCollection.get(n)&&(this.setForeignKey(e,t),this.canAutoAddLinks&&(t=this.relatedCollection.add(t))),t},findExistingLinksByForeignKey:function findExistingLinksByForeignKey(e){if(void 0!==e&&null!==e)return this.relatedCollection.filter(n({},this.foreignKey,e))},ensureLinkedDataHasProperType:function ensureLinkedDataHasProperType(e,t){var n=this.getRelation(),i=this.getLocalField(e);(!d.isArray(i)||i.length&&!n.is(i[0]))&&i&&!n.is(i)&&d.set(e,this.localField,n.createRecord(i,t))},isRequiresParentId:function isRequiresParentId(){return!1},isRequiresChildId:function isRequiresChildId(){return!1},createChildRecord:function createChildRecord(e,t,n){var i=this;return this.setForeignKey(e,t),this.createLinked(t,n).then(function(t){i.setLocalField(e,t)})},createLinked:function createLinked(e,t){var n=d.isArray(e)?"createMany":"create";return this.getRelation()[n](e,t)}}),[Relation.extend({getForeignKey:function getForeignKey(e){return d.get(e,this.foreignKey)},_setForeignKey:function _setForeignKey(e,t){d.set(e,this.foreignKey,d.get(t,this.getRelation().idAttribute))},findExistingLinksFor:function findExistingLinksFor(e){if(e){var t=d.get(e,this.foreignKey);return void 0!==t&&null!==t?this.relatedCollection.get(t):void 0}},isRequiresParentId:function isRequiresParentId(){return!0},createParentRecord:function createParentRecord(e,t){var n=this,i=this.getLocalField(e);return this.createLinked(i,t).then(function(t){n.setForeignKey(e,t)})},createChildRecord:function createChildRecord(){throw new Error('"BelongsTo" relation does not support child creation as it cannot have children.')}},{TYPE_NAME:"belongsTo"}),Relation.extend({validateOptions:function validateOptions(e,t){Relation.prototype.validateOptions.call(this,e,t);var n=t.localKeys,i=t.foreignKeys,r=t.foreignKey;if(!r&&!n&&!i)throw d.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",r)},canFindLinkFor:function canFindLinkFor(e){return!!(this.foreignKey||this.foreignKeys||this.localKeys&&d.get(e,this.localKeys))},linkRecord:function linkRecord(e,t){var n=this,i=this.relatedCollection,r=this.canAutoAddLinks,o=this.foreignKey,a=this.relatedCollection.unsaved();return t.map(function(t){var s=i.recordId(t);return(void 0===s&&-1===a.indexOf(t)||t!==i.get(s))&&(o&&n.setForeignKey(e,t),r&&(t=i.add(t))),t})},findExistingLinksFor:function findExistingLinksFor(e){var t=d.get(e,this.mapper.idAttribute),n=this.localKeys?d.get(e,this.localKeys):null,i=void 0;if(void 0!==t&&this.foreignKey?i=this.findExistingLinksByForeignKey(t):this.localKeys&&n?i=this.findExistingLinksByLocalKeys(n):void 0!==t&&this.foreignKeys&&(i=this.findExistingLinksByForeignKeys(t)),i&&i.length)return i},findExistingLinksByLocalKeys:function findExistingLinksByLocalKeys(e){return this.relatedCollection.filter({where:n({},this.mapper.idAttribute,{in:e})})},findExistingLinksByForeignKeys:function findExistingLinksByForeignKeys(e){return this.relatedCollection.filter({where:n({},this.foreignKeys,{contains:e})})},isRequiresParentId:function isRequiresParentId(){return!!this.localKeys&&this.localKeys.length>0},isRequiresChildId:function isRequiresChildId(){return!!this.foreignKey},createParentRecord:function createParentRecord(e,t){var n=this,i=this.getLocalField(e),r=this.getRelation().idAttribute;return this.createLinked(i,t).then(function(t){d.set(e,n.localKeys,t.map(function(e){return d.get(e,r)}))})},createLinked:function createLinked(e,t){return this.getRelation().createMany(e,t)}},{TYPE_NAME:"hasMany"}),Relation.extend({findExistingLinksFor:function findExistingLinksFor(e,t){var n=d.get(t,e.idAttribute),i=this.findExistingLinksByForeignKey(n);if(i&&i.length)return i[0]},isRequiresChildId:function isRequiresChildId(){return!0}},{TYPE_NAME:"hasOne"})].forEach(function(e){Relation[e.TYPE_NAME]=function(t,n){return new e(t,n)}});var x=function belongsTo(e,t){return function(n){Relation.belongsTo(e,t).assignTo(n)}},C=function hasMany(e,t){return function(n){Relation.hasMany(e,t).assignTo(n)}},w=function hasOne(e,t){return function(n){Relation.hasOne(e,t).assignTo(n)}},R=function superMethod(e,t){var n=e.datastore;return n&&n[t]?function(){for(var i=arguments.length,r=Array(i),o=0;o<i;o++)r[o]=arguments[o];return n[t].apply(n,[e.name].concat(r))}:e[t].bind(e)},k="creating",I="noValidate",F="keepChangeHistory",E="previous",j=p.extend({constructor:Record,_mapper:function _mapper(){var e=this.constructor.mapper;if(!e)throw d.err("Record#_mapper","")(404,"mapper");return e},afterLoadRelations:function afterLoadRelations(){},beforeLoadRelations:function beforeLoadRelations(){},changeHistory:function changeHistory(){return(this._get("history")||[]).slice()},changes:function changes(e){return e||(e={}),d.diffObjects("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},commit:function commit(e){this._set("changed"),this._set("history",[]),this._set("previous",this.toJSON(e))},destroy:function destroy(e){e||(e={});var t=this._mapper();return R(t,"destroy")(d.get(this,t.idAttribute),e)},get:function get$$1(e){return d.get(this,e)},hasChanges:function hasChanges(e){return!!(this._get("changed")||[]).length||d.areDifferent("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},isNew:function isNew(e){return void 0===d.get(this,this._mapper().idAttribute)},isValid:function isValid(e){return!this._mapper().validate(this,e)},removeInverseRelation:function removeInverseRelation(e,t,n,i){var r=this;if("hasOne"===n.type)h(e,n.localField,void 0);else if("hasMany"===n.type){var o=d.get(e,n.localField);void 0===t?d.remove(o,function(e){return e===r}):d.remove(o,function(e){return e===r||t===d.get(e,i)})}},setupInverseRelation:function setupInverseRelation(e,t,n,i){var r=this;if("hasOne"===n.type)h(e,n.localField,this);else if("hasMany"===n.type){var o=d.get(e,n.localField);void 0===t?d.noDupeAdd(o,this,function(e){return e===r}):d.noDupeAdd(o,this,function(e){return e===r||t===d.get(e,i)})}},loadRelations:function loadRelations(e,t){var i=this,r=void 0,o=this._mapper();return e||(e=[]),d.isString(e)&&(e=[e]),t||(t={}),t.with=e,d._(t,o),t.adapter=o.getAdapterName(t),r=t.op="beforeLoadRelations",d.resolve(this[r](e,t)).then(function(){r=t.op="loadRelations",o.dbg(r,i,e,t);var a=[],s=void 0;return d.forEachRelation(o,t,function(e,r){var c=e.getRelation();if(r.raw=!1,d.isFunction(e.load))s=e.load(o,e,i,t);else if("hasMany"===e.type||"hasOne"===e.type)e.foreignKey?s=R(c,"findAll")(n({},e.foreignKey,d.get(i,o.idAttribute)),r).then(function(t){return"hasOne"===e.type?t.length?t[0]:void 0:t}):e.localKeys?s=R(c,"findAll")({where:n({},c.idAttribute,{in:d.get(i,e.localKeys)})}):e.foreignKeys&&(s=R(c,"findAll")({where:n({},e.foreignKeys,{contains:d.get(i,o.idAttribute)})},t));else if("belongsTo"===e.type){var l=d.get(i,e.foreignKey);d.isSorN(l)&&(s=R(c,"find")(l,r))}s&&(s=s.then(function(t){e.setLocalField(i,t)}),a.push(s))}),Promise.all(a)}).then(function(){return r=t.op="afterLoadRelations",d.resolve(i[r](e,t)).then(function(){return i})})},previous:function previous(e){return e?this._get("previous."+e):this._get("previous")},revert:function revert(e){var t=this,n=this._get("previous");e||(e={}),e.preserve||(e.preserve=[]),d.forOwn(this,function(i,r){r!==t._mapper().idAttribute&&!n.hasOwnProperty(r)&&t.hasOwnProperty(r)&&-1===e.preserve.indexOf(r)&&delete t[r]}),d.forOwn(n,function(n,i){-1===e.preserve.indexOf(i)&&(t[i]=n)}),this.commit()},save:function save(e){var t=this;e||(e={});var n=this._mapper(),i=d.get(this,n.idAttribute),r=this,o=function postProcess(n){var i=e.raw?n.data:n;return i&&(d.deepMixIn(t,i),t.commit()),n};if(void 0===i)return R(n,"create")(r,e).then(o);if(e.changesOnly){var a=this.changes(e);r={},d.fillIn(r,a.added),d.fillIn(r,a.changed)}return R(n,"update")(i,r,e).then(o)},set:function set$$1(e,t,n){d.isObject(e)&&(n=t),n||(n={}),n.silent&&this._set("silent",!0),d.set(this,e,t),this._get("eventId")||this._set("silent")},toJSON:function toJSON(e){var t=this.constructor.mapper;if(t)return t.toJSON(this,e);var n={};return d.forOwn(this,function(e,t){n[t]=d.plainCopy(e)}),n},unset:function unset(e,t){this.set(e,void 0,t)},validate:function validate(e){return this._mapper().validate(this,e)}},{creatingPath:k,noValidatePath:I,keepChangeHistoryPath:F,previousPath:E});d.eventify(Record.prototype,function(){return this._get("events")},function(e){this._set("events",e)}),d.addHiddenPropsToTarget(Index.prototype,{set:function set(e,t){d.isArray(e)||(e=[e]);var n=e.shift()||void 0,i=binarySearch(this.keys,n);if(0===e.length)if(i.found){var r=binarySearch(this.values[i.index],t,this.hashCode);r.found||insertAt(this.values[i.index],r.index,t)}else insertAt(this.keys,i.index,n),insertAt(this.values,i.index,[t]);else if(i.found)this.values[i.index].set(e,t);else{insertAt(this.keys,i.index,n);var o=new Index([],{hashCode:this.hashCode});o.set(e,t),insertAt(this.values,i.index,o)}},get:function get(e){d.isArray(e)||(e=[e]);var t=e.shift()||void 0,n=binarySearch(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index].slice():[]:n.found?this.values[n.index].get(e):[]},getAll:function getAll(e){e||(e={});var t=[],n=this.values;if("desc"===e.order)for(var i=n.length-1;i>=0;i--){var r=n[i];t=r.isIndex?t.concat(r.getAll(e)):t.concat(r)}else for(var o=0;o<n.length;o++){var a=n[o];t=a.isIndex?t.concat(a.getAll(e)):t.concat(a)}return t},visitAll:function visitAll(e,t){this.values.forEach(function(n){n.isIndex?n.visitAll(e,t):n.forEach(e,t)})},between:function between(e,t,n){n||(n={}),d.isArray(e)||(e=[e]),d.isArray(t)||(t=[t]),d.fillIn(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var i=this._between(e,t,n);return n.limit?i.slice(n.offset,n.limit+n.offset):i.slice(n.offset)},_between:function _between(e,t,n){var i=[],r=e.shift(),o=t.shift(),a=void 0;if(a=void 0!==r?binarySearch(this.keys,r):{found:!1,index:0},0===e.length){a.found&&!1===n.leftInclusive&&(a.index+=1);for(var s=a.index;s<this.keys.length;s+=1){if(void 0!==o)if(n.rightInclusive){if(this.keys[s]>o)break}else if(this.keys[s]>=o)break;if(i=this.values[s].isIndex?i.concat(this.values[s].getAll()):i.concat(this.values[s]),n.limit&&i.length>=n.limit+n.offset)break}}else for(var c=a.index;c<this.keys.length;c+=1){var l=this.keys[c];if(l>o)break;if(i=this.values[c].isIndex?l===r?i.concat(this.values[c]._between(d.copy(e),t.map(function(){}),n)):l===o?i.concat(this.values[c]._between(e.map(function(){}),d.copy(t),n)):i.concat(this.values[c].getAll()):i.concat(this.values[c]),n.limit&&i.length>=n.limit+n.offset)break}return n.limit?i.slice(0,n.limit+n.offset):i},peek:function peek(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},clear:function clear(){this.keys=[],this.values=[]},insertRecord:function insertRecord(e){var t=this.fieldList.map(function(t){return d.isFunction(t)?t(e)||void 0:e[t]||void 0});this.set(t,e)},removeRecord:function removeRecord(e){var t=this,n=void 0,i=void 0!==this.hashCode(e);return this.values.forEach(function(r,o){if(r.isIndex){if(r.removeRecord(e))return 0===r.keys.length&&(removeAt(t.keys,o),removeAt(t.values,o)),n=!0,!1}else{var a={};if(void 0!==t.keys[o]&&i)i&&(a=binarySearch(r,e,t.hashCode));else for(var s=r.length-1;s>=0;s--)if(r[s]===e){a={found:!0,index:s};break}if(a.found)return removeAt(r,a.index),0===r.length&&(removeAt(t.keys,o),removeAt(t.values,o)),n=!0,!1}}),n?e:void 0},updateRecord:function updateRecord(e){void 0!==this.removeRecord(e)&&this.insertRecord(e)}});var S=j.noValidatePath,P={commitOnMerge:!0,emitRecordEvents:!0,idAttribute:"id",onConflict:"merge"},M=p.extend({constructor:Collection,_onRecordEvent:function _onRecordEvent(){this.emitRecordEvents&&this.emit.apply(this,arguments)},add:function add(e,t){var n=this;t||(t={}),d._(t,this),e=this.beforeAdd(e,t)||e;var i=!1,r=this.recordId();if(!d.isArray(e)){if(!d.isObject(e))throw d.err("Collection#add","records")(400,"object or array",e);e=[e],i=!0}e=e.map(function(e){var i=n.recordId(e),o=void 0===i?i:n.get(i);if(e===o)return o;if(o){var a=t.onConflict||n.onConflict;if("merge"!==a&&"replace"!==a&&"skip"!==a)throw d.err("Collection#add","opts.onConflict")(400,"one of (merge, replace, skip)",a,!0);var s=o._get(S);t.noValidate&&o._set(S,!0),"merge"===a?d.deepMixIn(o,e):"replace"===a&&(d.forOwn(o,function(t,n){n!==r&&void 0===e[n]&&(o[n]=void 0)}),o.set(e)),t.noValidate&&o._set(S,s),e=o,t.commitOnMerge&&d.isFunction(e.commit)&&e.commit(),n.updateIndexes(e)}else e=n.mapper?n.mapper.createRecord(e,t):e,n.index.insertRecord(e),d.forOwn(n.indexes,function(t,n){t.insertRecord(e)}),e&&d.isFunction(e.on)&&e.on("all",n._onRecordEvent,n);return e});var o=i?e[0]:e;return t.silent||this.emit("add",o),this.afterAdd(e,t,o)||o},afterAdd:function afterAdd(){},afterRemove:function afterRemove(){},afterRemoveAll:function afterRemoveAll(){},beforeAdd:function beforeAdd(){},beforeRemove:function beforeRemove(){},beforeRemoveAll:function beforeRemoveAll(){},between:function between(e,t,n){return this.query().between(e,t,n).run()},createIndex:function createIndex(e,t,n){var i=this;d.isString(e)&&void 0===t&&(t=[e]),n||(n={}),n.hashCode||(n.hashCode=function(e){return i.recordId(e)});var r=this.indexes[e]=new Index(t,n);this.index.visitAll(r.insertRecord,r)},filter:function filter(e,t){return this.query().filter(e,t).run()},forEach:function forEach(e,t){this.index.visitAll(e,t)},get:function get(e){var t=void 0===e?[]:this.query().get(e).run();return t.length?t[0]:void 0},getAll:function getAll(){var e;return(e=this.query()).getAll.apply(e,arguments).run()},getIndex:function getIndex(e){var t=e?this.indexes[e]:this.index;if(!t)throw d.err("Collection#getIndex",e)(404,"index");return t},limit:function limit(e){return this.query().limit(e).run()},map:function map(e,t){var n=[];return this.index.visitAll(function(i){n.push(e.call(t,i))}),n},mapCall:function mapCall(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=[];return this.index.visitAll(function(t){r.push(t[e].apply(t,n))}),r},prune:function prune(e){return this.removeAll(this.unsaved(),e)},query:function query(){return new(0,this.queryClass)(this)},recordId:function recordId(e){return e?d.get(e,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute},reduce:function reduce(e,t){return this.getAll().reduce(e,t)},remove:function remove(e,t){t||(t={}),this.beforeRemove(e,t);var n=d.isSorN(e)?this.get(e):e;return d.isObject(n)&&(n=this.index.removeRecord(n))&&(d.forOwn(this.indexes,function(e,t){e.removeRecord(n)}),d.isFunction(n.off)&&(n.off("all",this._onRecordEvent,this),t.silent||this.emit("remove",n))),this.afterRemove(e,t,n)||n},removeAll:function removeAll(e,t){var n=this;t||(t={}),this.beforeRemoveAll(e,t);var i=d.isArray(e)?e.slice():this.filter(e),r=d.plainCopy(t);return r.silent=!0,i=i.map(function(e){return n.remove(e,r)}).filter(function(e){return e}),t.silent||this.emit("remove",i),this.afterRemoveAll(e,t,i)||i},skip:function skip(e){return this.query().skip(e).run()},toJSON:function toJSON(e){return this.mapCall("toJSON",e)},unsaved:function unsaved(e){return this.index.get()},updateIndex:function updateIndex(e,t){t||(t={}),this.getIndex(t.index).updateRecord(e)},updateIndexes:function updateIndexes(e){this.index.updateRecord(e),d.forOwn(this.indexes,function(t,n){t.updateRecord(e)})}}),L={array:d.isArray,boolean:d.isBoolean,integer:d.isInteger,null:d.isNull,number:d.isNumber,object:d.isObject,string:d.isString},K=function segmentToString(e,t){var n="";return e&&(d.isNumber(e)?n+="["+e+"]":n+=t?"."+e:""+e),n},N=function makePath(e){e||(e={});var t="";return(e.path||[]).forEach(function(e){t+=K(e,t)}),t+=K(e.prop,t)},D=function makeError(e,t,n){return{expected:t,actual:""+e,path:N(n)}},T=function addError(e,t,n,i){i.push(D(e,t,n))},q=function maxLengthCommon(e,t,n,i){var r=n[e];if(t.length>r)return D(t.length,"length no more than "+r,i)},Q=function minLengthCommon(e,t,n,i){var r=n[e];if(t.length<r)return D(t.length,"length no less than "+r,i)},J={allOf:function allOf(e,t,n){var i=[];return t.allOf.forEach(function(t){i=i.concat(Y(e,t,n)||[])}),i.length?i:void 0},anyOf:function anyOf(e,t,n){var i=!1,r=[];return t.anyOf.forEach(function(t){var o=Y(e,t,n);o?r=r.concat(o):i=!0}),i?void 0:r},dependencies:function dependencies(e,t,n){},enum:function _enum(e,t,n){var i=t.enum;if(-1===d.findIndex(i,function(t){return d.deepEqual(t,e)}))return D(e,"one of ("+i.join(", ")+")",n)},items:function items(e,t,n){n||(n={});for(var items=t.items,i=[],r=d.isArray(items),o=e.length,a=0;a<o;a++)r&&(items=t.items[a]),n.prop=a,i=i.concat(Y(e[a],items,n)||[]);return i.length?i:void 0},maximum:function maximum(e,n,i){var maximum=n.maximum,r=n.exclusiveMaximum;if((void 0===e?"undefined":t(e))===(void 0===maximum?"undefined":t(maximum))&&!(r?maximum>e:maximum>=e))return r?D(e,"no more than nor equal to "+maximum,i):D(e,"no more than "+maximum,i)},maxItems:function maxItems(e,t,n){if(d.isArray(e))return q("maxItems",e,t,n)},maxLength:function maxLength(e,t,n){return q("maxLength",e,t,n)},maxProperties:function maxProperties(e,t,n){if(d.isObject(e)){var maxProperties=t.maxProperties,i=Object.keys(e).length;return i>maxProperties?D(i,"no more than "+maxProperties+" properties",n):void 0}},minimum:function minimum(e,n,i){var minimum=n.minimum,r=n.exclusiveMinimum;if((void 0===e?"undefined":t(e))===(void 0===minimum?"undefined":t(minimum))&&!(r?e>minimum:e>=minimum))return r?D(e,"no less than nor equal to "+minimum,i):D(e,"no less than "+minimum,i)},minItems:function minItems(e,t,n){if(d.isArray(e))return Q("minItems",e,t,n)},minLength:function minLength(e,t,n){return Q("minLength",e,t,n)},minProperties:function minProperties(e,t,n){if(d.isObject(e)){var minProperties=t.minProperties,i=Object.keys(e).length;return i<minProperties?D(i,"no more than "+minProperties+" properties",n):void 0}},multipleOf:function multipleOf(e,t,n){var multipleOf=t.multipleOf;if(d.isNumber(e)&&e/multipleOf%1!=0)return D(e,"multipleOf "+multipleOf,n)},not:function not(e,t,n){if(!Y(e,t.not,n))return D("succeeded","should have failed",n)},oneOf:function oneOf(e,t,n){var i=!1,r=[];return t.oneOf.forEach(function(t){var o=Y(e,t,n);if(o)r=r.concat(o);else{if(i)return r=[D("valid against more than one","valid against only one",n)],i=!1,!1;i=!0}}),i?void 0:r},pattern:function pattern(e,t,n){var pattern=t.pattern;if(d.isString(e)&&!e.match(pattern))return D(e,pattern,n)},properties:function properties(e,t,n){if(n||(n={}),!d.isArray(e)){var i=void 0===t.additionalProperties||t.additionalProperties,r=[],properties=t.properties||{},o=t.patternProperties||{},a=[];d.forOwn(properties,function(t,i){n.prop=i,a=a.concat(Y(e[i],t,n)||[]),r.push(i)});var s=d.omit(e,r);d.forOwn(o,function(t,i){d.forOwn(s,function(o,s){s.match(i)&&(n.prop=s,a=a.concat(Y(e[s],t,n)||[]),r.push(s))})});var c=Object.keys(d.omit(e,r));if(!1===i){if(c.length){var l=n.prop;n.prop="",T("extra fields: "+c.join(", "),"no extra fields",n,a),n.prop=l}}else d.isObject(i)&&c.forEach(function(t){n.prop=t,a=a.concat(Y(e[t],i,n)||[])});return a.length?a:void 0}},required:function required(e,t,n){n||(n={});var required=t.required,i=[];return n.existingOnly||required.forEach(function(t){if(void 0===d.get(e,t)){var r=n.prop;n.prop=t,T(void 0,"a value",n,i),n.prop=r}}),i.length?i:void 0},type:function type(e,n,i){var type=n.type,r=void 0;if(d.isString(type)&&(type=[type]),type.forEach(function(t){if(L[t](e,n,i))return r=t,!1}),!r)return D(void 0!==e&&null!==e?void 0===e?"undefined":t(e):""+e,"one of ("+type.join(", ")+")",i);var o=z[r];return o?o(e,n,i):void 0},uniqueItems:function uniqueItems(e,t,n){if(e&&e.length&&t.uniqueItems){var i=void 0,r=void 0,o=void 0;for(r=e.length-1;r>0;r--)for(i=e[r],o=r-1;o>=0;o--)if(d.deepEqual(i,e[o]))return D(i,"no duplicates",n)}}},B=function runOps(e,t,n,i){var r=[];return e.forEach(function(e){void 0!==n[e]&&(r=r.concat(J[e](t,n,i)||[]))}),r.length?r:void 0},$=["enum","type","allOf","anyOf","oneOf","not"],H=["items","maxItems","minItems","uniqueItems"],U=["multipleOf","maximum","minimum"],V=["maxProperties","minProperties","required","properties","dependencies"],G=["maxLength","minLength","pattern"],W=function validateAny(e,t,n){return B($,e,t,n)},Y=function _validate(e,t,n){var i=[];n||(n={}),n.ctx||(n.ctx={value:e,schema:t});var r=void 0,o=n.prop;if(void 0!==t){if(!d.isObject(t))throw d.err("Schema#validate")(500,'Invalid schema at path: "'+n.path+'"');return void 0===n.path&&(n.path=[]),void 0!==n.prop&&(r=!0,n.path.push(n.prop),n.prop=void 0),t.extends&&(i=d.isFunction(t.extends.validate)?i.concat(t.extends.validate(e,n)||[]):i.concat(_validate(e,t.extends,n)||[])),void 0===e?(!0!==t.required||n.existingOnly||T(e,"a value",n,i),r&&(n.path.pop(),n.prop=o),i.length?i:void 0):(i=i.concat(W(e,t,n)||[]),r&&(n.path.pop(),n.prop=o),i.length?i:void 0)}},z={array:function array(e,t,n){return B(H,e,t,n)},integer:function integer(e,t,n){return z.numeric(e,t,n)},number:function number(e,t,n){return z.numeric(e,t,n)},numeric:function numeric(e,t,n){return B(U,e,t,n)},object:function object(e,t,n){return B(V,e,t,n)},string:function string(e,t,n){return B(G,e,t,n)}},X=p.extend({constructor:Schema,apply:function apply(e,t){var n=this;t||(t={}),t.getter||(t.getter="_get"),t.setter||(t.setter="_set"),t.unsetter||(t.unsetter="_unset"),t.track||(t.track=this.track);var i=this.properties||{};d.forOwn(i,function(i,r){Object.defineProperty(e,r,n.makeDescriptor(r,i,t))})},applyDefaults:function applyDefaults(e){if(e){var t=this.properties||{},n=d.isFunction(e.set)||d.isFunction(e._set);d.forOwn(t,function(t,i){if(t.hasOwnProperty("default")&&void 0===d.get(e,i)&&(n?e.set(i,d.plainCopy(t.default),{silent:!0}):d.set(e,i,d.plainCopy(t.default))),"object"===t.type&&t.properties){if(n){var r=e._get("noValidate");e._set("noValidate",!0),d.set(e,i,d.get(e,i)||{},{silent:!0}),e._set("noValidate",r)}else d.set(e,i,d.get(e,i)||{});t.applyDefaults(d.get(e,i))}})}},makeDescriptor:function makeDescriptor(e,t,i){var r={configurable:!0,enumerable:void 0===t.enumerable||!!t.enumerable},o="props."+e,a="previous."+e,s=i.getter,c=i.setter,l=i.unsetter,u=d.isBoolean(i.track)?i.track:t.track;if(r.get=function(){return this._get(o)},d.isFunction(t.get)){var f=r.get;r.get=function(){return t.get.call(this,f)}}if(r.set=function(i){var r=this,f=this[s],h=this[c],p=this[l];if(!f("noValidate")){var v=t.validate(i,{path:[e]});if(v){var g=new Error("validation failed");throw g.errors=v,g}}if(u&&!f("creating")){var y=f(a),m=f(o),A=f("changing"),b=f("changed");A||(b=[]);var O=b.indexOf(e);m!==i&&-1===O&&b.push(e),y===i&&O>=0&&b.splice(O,1),b.length||(A=!1,p("changing"),p("changed"),f("eventId")&&(clearTimeout(f("eventId")),p("eventId"))),!A&&b.length&&(h("changed",b),h("changing",!0),h("eventId",setTimeout(function(){if(p("changed"),p("eventId"),p("changing"),!f("silent")){var t=void 0;for(t=0;t<b.length;t++)r.emit("change:"+b[t],r,d.get(r,b[t]));var o=d.diffObjects(n({},e,i),n({},e,m));if(f("keepChangeHistory")){var a=d.plainCopy(o);a.timestamp=(new Date).getTime();var s=f("history");!s&&h("history",s=[]),s.push(a)}r.emit("change",r,o)}p("silent")},0)))}return h(o,i),i},d.isFunction(t.set)){var h=r.set;r.set=function(e){return t.set.call(this,e,h)}}return r},pick:function pick(e){var t=this;if(void 0!==e){if("object"===this.type){var n={},i=this.properties;if(i&&d.forOwn(i,function(t,i){n[i]=t.pick(e[i])}),this.extends&&d.fillIn(n,this.extends.pick(e)),this.additionalProperties)for(var r in e)i[r]||(n[r]=d.plainCopy(e[r]));return n}return"array"===this.type?e.map(function(e){var n=t.items?t.items.pick(e):{};return t.extends&&d.fillIn(n,t.extends.pick(e)),n}):d.plainCopy(e)}},validate:function validate(e,t){return Y(e,this,t)}},{ANY_OPS:$,ARRAY_OPS:H,NUMERIC_OPS:U,OBJECT_OPS:V,STRING_OPS:G,typeGroupValidators:z,types:L,validate:Y,validationKeywords:J}),Z="Mapper",ee=["beforeCreate","beforeCreateMany"],te=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"],ne=function makeNotify(e){return function(){for(var t=this,n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];var o=i[i.length-e],a=o.op;if(this.dbg.apply(this,[a].concat(i)),-1!==ee.indexOf(a)&&!1!==o.applyDefaults){var s=this.getSchema();if(s&&s.applyDefaults){var c=i[0];d.isArray(c)||(c=[c]),c.forEach(function(e){s.applyDefaults(e)})}}if(-1!==te.indexOf(a)&&!o.noValidate){var l=o.existingOnly;0===a.indexOf("beforeUpdate")&&void 0===o.existingOnly&&(o.existingOnly=!0);var u=this.validate(i["beforeUpdate"===a?1:0],d.pick(o,["existingOnly"]));if(o.existingOnly=l,u){var f=new Error("validation failed");return f.errors=u,d.reject(f)}}(o.notify||void 0===o.notify&&this.notify)&&setTimeout(function(){t.emit.apply(t,[a].concat(i))})}},ie=ne(1),re=ne(2),oe={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function adapterArgs(e,t,n,i){return[t,e.toJSON(n,i),i]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function adapterArgs(e,t,n,i){return[e.toJSON(t,i),n,i]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function adapterArgs(e,t,n){return[t.map(function(t){return e.toJSON(t,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},ae={_adapters:{},applyDefaults:!0,applySchema:!0,defaultAdapter:"http",idAttribute:"id",keepChangeHistory:!0,notify:!0,noValidate:!1,raw:!1,validateOnSet:!0},se=p.extend({constructor:Mapper,afterCount:re,afterCreate:re,afterCreateMany:re,afterDestroy:re,afterDestroyAll:re,afterFind:re,afterFindAll:re,afterSum:re,afterUpdate:re,afterUpdateAll:re,afterUpdateMany:re,beforeCreate:ie,beforeCreateMany:ie,beforeCount:ie,beforeDestroy:ie,beforeDestroyAll:ie,beforeFind:ie,beforeFindAll:ie,beforeSum:ie,beforeUpdate:ie,beforeUpdateAll:ie,beforeUpdateMany:ie,_end:function _end(e,t,n){if(t.raw&&d._(e,t),n)return e;var i=t.raw?e.data:e;return i&&d.isFunction(this.wrap)&&(i=this.wrap(i,t),t.raw?e.data=i:e=i),e},belongsTo:function belongsTo$$1(e,t){return x(e,t)(this)},count:function count(e,t){return this.crud("count",e,t)},create:function create(e,t){var n=this;e||(e={}),t||(t={});var i=e,r={},o={};return d._(t,this),t.adapter=this.getAdapterName(t),t.op="beforeCreate",this._runHook(t.op,e,t).then(function(e){return t.with||(t.with=[]),n._createParentRecordIfRequired(e,t)}).then(function(e){r=e}).then(function(){return t.op="create",n._invokeAdapterMethod(t.op,e,t)}).then(function(e){o=e}).then(function(){var i=t.raw?o.data:o;return n._createOrAssignChildRecordIfRequired(i,{opts:t,parentRelationMap:r,originalProps:e})}).then(function(e){return n._commitChanges(i,e)}).then(function(i){t.raw?o.data=i:o=i;var r=n._end(o,t);return t.op="afterCreate",n._runHook(t.op,e,t,r)})},_commitChanges:function _commitChanges(e,t){var n=this;return d.isArray(e)?e.map(function(e,i){return n._commitChanges(e,t[i])}):(d.set(e,t,{silent:!0}),d.isFunction(e.commit)&&e.commit(),e)},createInstance:function createInstance(e,t){return this.createRecord(e,t)},_createParentRecordIfRequired:function _createParentRecordIfRequired(e,t){var n=[],i=[];return d.forEachRelation(this,t,function(t,r){t.isRequiresParentId()&&t.getLocalField(e)&&(r.raw=!1,i.push(t),n.push(t.createParentRecord(e,r)))}),d.Promise.all(n).then(function(e){return i.reduce(function(t,n,i){return n.setLocalField(t,e[i]),t},{})})},_createOrAssignChildRecordIfRequired:function _createOrAssignChildRecordIfRequired(e,t){var n=[];return d.forEachRelation(this,t.opts,function(i,r){var o=i.getLocalField(t.originalProps);if(o)if(r.raw=!1,i.isRequiresChildId())n.push(i.createChildRecord(e,o,r));else if(i.isRequiresParentId()){var a=i.getLocalField(t.parentRelationMap);a&&i.setLocalField(e,a)}}),d.Promise.all(n).then(function(){return e})},createMany:function createMany(e,t){var n=this;e||(e=[]),t||(t={});var i=e,r=void 0;return d._(t,this),t.adapter=this.getAdapterName(t),t.op="beforeCreateMany",this._runHook(t.op,e,t).then(function(e){var o={};t.with||(t.with=[]);var a=[];return d.forEachRelation(n,t,function(t,n){var i=e.map(function(e){return t.getLocalField(e)}).filter(Boolean);"belongsTo"===t.type&&i.length===e.length&&(n.raw=!1,a.push(t.createLinked(i,n).then(function(n){e.forEach(function(e,i){return t.setForeignKey(e,n[i])})}).then(function(e){t.setLocalField(o,e)})))}),d.Promise.all(a).then(function(){return t.op="createMany",n._invokeAdapterMethod(t.op,e,t)}).then(function(e){r=e}).then(function(){var s=t.raw?r.data:r;return a=[],d.forEachRelation(n,t,function(t,i){var r=e.map(function(e){return t.getLocalField(e)}).filter(Boolean);if(r.length===e.length){i.raw=!1;var c=t.getLocalField(o),l=void 0;"hasMany"===t.type?n.log("warn","deep createMany of hasMany type not supported!"):"hasOne"===t.type?(s.forEach(function(e,n){t.setForeignKey(e,r[n])}),l=t.getRelation().createMany(r,i).then(function(e){s.forEach(function(n,i){t.setLocalField(n,e[i])})})):"belongsTo"===t.type&&c&&c.length===s.length&&s.forEach(function(e,n){t.setLocalField(e,c[n])}),l&&a.push(l)}}),d.Promise.all(a).then(function(){return n._commitChanges(i,s)})})}).then(function(e){t.raw?r.data=e:r=e;var i=n._end(r,t);return t.op="afterCreateMany",n._runHook(t.op,e,t,i)})},createRecord:function createRecord(e,t){var n=this;if(e||(e={}),d.isArray(e))return e.map(function(e){return n.createRecord(e,t)});if(!d.isObject(e))throw d.err(Z+"#createRecord","props")(400,"array or object",e);this.relationList&&this.relationList.forEach(function(n){n.ensureLinkedDataHasProperType(e,t)});var i=this.recordClass;return!i||e instanceof i?e:new i(e,t)},crud:function crud(e){for(var t=this,n=arguments.length,r=Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];var a=this.lifecycleMethods[e];if(!a)throw d.err(Z+"#crud",e)(404,"method");var s=""+e.charAt(0).toUpperCase()+e.substr(1),c="before"+s,l="after"+s,u=void 0,f=void 0;a.defaults.forEach(function(e,t){void 0===r[t]&&(r[t]=d.copy(e))});var h=r[r.length-1];return d._(h,this),f=h.adapter=this.getAdapterName(h),u=h.op=c,d.resolve(this[u].apply(this,i(r))).then(function(n){var o;return void 0!==r[a.beforeAssign]&&(r[a.beforeAssign]=void 0===n?r[a.beforeAssign]:n),u=h.op=e,r=a.adapterArgs?a.adapterArgs.apply(a,[t].concat(i(r))):r,t.dbg.apply(t,[u].concat(i(r))),d.resolve((o=t.getAdapter(f))[u].apply(o,[t].concat(i(r))))}).then(function(e){return e=t._end(e,h,!!a.skip),r.push(e),u=h.op=l,d.resolve(t[u].apply(t,i(r))).then(function(t){return void 0===t?e:t})})},destroy:function destroy(e,t){return this.crud("destroy",e,t)},destroyAll:function destroyAll(e,t){return this.crud("destroyAll",e,t)},find:function find(e,t){return this.crud("find",e,t)},findAll:function findAll(e,t){return this.crud("findAll",e,t)},getAdapter:function getAdapter(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw d.err(Z+"#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e||(e={}),d.isString(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getSchema:function getSchema(){return this.schema},hasMany:function hasMany$$1(e,t){return C(e,t)(this)},hasOne:function hasOne$$1(e,t){return w(e,t)(this)},is:function is(e){var t=this.recordClass;return!!t&&e instanceof t},registerAdapter:function registerAdapter(e,t,n){n||(n={}),this.getAdapters()[e]=t,(!0===n||n.default)&&(this.defaultAdapter=e)},_runHook:function _runHook(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=0===e.indexOf("after")?n.length-1:0;return d.resolve(this[e].apply(this,n)).then(function(e){return void 0===e?n[r]:e})},_invokeAdapterMethod:function _invokeAdapterMethod(e,t,n){var i=this,r={with:n.pass||[]},o=void 0;return this.dbg(n.op,t,n),o=d.isArray(t)?t.map(function(e){return i.toJSON(e,r)}):this.toJSON(t,r),this.getAdapter(n.adapter)[e](this,o,n)},sum:function sum(e,t,n){return this.crud("sum",e,t,n)},toJSON:function toJSON(e,t){var n=this,i=void 0;if(t||(t={}),d.isArray(e))return e.map(function(e){return n.toJSON(e,t)});i=e;var r=(this?this.relationFields:[])||[],o={};if(this&&this.schema)o=this.schema.pick(i);else for(var a in i)-1===r.indexOf(a)&&(o[a]=d.plainCopy(i[a]));return this&&t.withAll&&(t.with=r.slice()),this&&t.with&&(d.isString(t.with)&&(t.with=[t.with]),d.forEachRelation(this,t,function(e,t){var n=e.getLocalField(i);n&&(d.isArray(n)?e.setLocalField(o,n.map(function(n){return e.getRelation().toJSON(n,t)})):e.setLocalField(o,e.getRelation().toJSON(n,t)))})),o},update:function update(e,t,n){return this.crud("update",e,t,n)},updateAll:function updateAll(e,t,n){return this.crud("updateAll",e,t,n)},updateMany:function updateMany(e,t){return this.crud("updateMany",e,t)},validate:function validate(e,t){t||(t={});var n=this.getSchema();if(n){var i=d.pick(t,["existingOnly"]);if(d.isArray(e)){var r=e.map(function(e){return n.validate(e,d.pick(i,["existingOnly"]))});return r.some(Boolean)?r:void 0}return n.validate(e,i)}},wrap:function wrap(e,t){return this.createRecord(e,t)},defineRelations:function defineRelations(){var e=this;d.forOwn(this.relations,function(t,n){d.forOwn(t,function(t,i){d.isObject(t)&&(t=[t]),t.forEach(function(t){var r=e.datastore.getMapperByName(i)||i;if(t.getRelation=function(){return e.datastore.getMapper(i)},"function"!=typeof Relation[n])throw d.err(Z,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",n,!0);e[n](r,t)})})})}}),ce=["count","create","createMany","createRecord","destroy","destroyAll","find","findAll","getSchema","is","sum","toJSON","update","updateAll","updateMany","validate"],le={constructor:Container,_onMapperEvent:function _onMapperEvent(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n.shift();this.emit.apply(this,[r,e].concat(n))},as:function as(e){var t={},n=this;return ce.forEach(function(i){t[i]={writable:!0,value:function value(){for(var t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];return n[i].apply(n,[e].concat(r))}}}),t.getMapper={writable:!0,value:function value(){return n.getMapper(e)}},Object.create(this,t)},defineMapper:function defineMapper(e,t){var n=this;if(d.isObject(e)&&(e=(t=e).name),!d.isString(e))throw d.err("Container#defineMapper","name")(400,"string",e);t||(t={}),t.name=e,t.relations||(t.relations={});var i=t.mapperClass||this.mapperClass;delete t.mapperClass,d.fillIn(t,this.mapperDefaults);var r=this._mappers[e]=new i(t);return r.relations||(r.relations={}),r.name=e,r._adapters=this.getAdapters(),r.datastore=this,r.on("all",function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return n._onMapperEvent.apply(n,[e].concat(i))}),r.defineRelations(),r},defineResource:function defineResource(e,t){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(e,t)},getAdapter:function getAdapter(e){var t=this.getAdapterName(e);if(!t)throw d.err("Container#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e||(e={}),d.isString(e)&&(e={adapter:e}),e.adapter||this.mapperDefaults.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getMapper:function getMapper(e){var t=this.getMapperByName(e);if(!t)throw d.err("Container#getMapper",e)(404,"mapper");return t},getMapperByName:function getMapperByName(e){return this._mappers[e]},registerAdapter:function registerAdapter(e,t,n){n||(n={}),this.getAdapters()[e]=t,(!0===n||n.default)&&(this.mapperDefaults.defaultAdapter=e,d.forOwn(this._mappers,function(t){t.defaultAdapter=e}))}};ce.forEach(function(e){le[e]=function(t){for(var n,i=arguments.length,r=Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return(n=this.getMapper(t))[e].apply(n,r)}}),p.extend(le);var ue=["add","between","createIndex","filter","get","getAll","prune","query","toJSON","unsaved"],de=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],fe=function cachedFn(e,t,n){var i=this._completedQueries[e][t];return d.isFunction(i)?i(e,t,n):i},he={usePendingFind:!0,usePendingFindAll:!0},pe={constructor:SimpleStore,_end:function _end(e,t,n){var i=n.raw?t.data:t;return i&&d.isFunction(this.addToCache)&&(i=this.addToCache(e,i,n),n.raw?t.data=i:t=i),t},_onCollectionEvent:function _onCollectionEvent(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n.shift();this.emit.apply(this,[r,e].concat(n))},addToCache:function addToCache(e,t,n){return this.getCollection(e).add(t,n)},as:function as(e){var t={},n=this;return de.concat(ce).concat(ue).forEach(function(i){t[i]={writable:!0,value:function value(){for(var t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];return n[i].apply(n,[e].concat(r))}}}),t.getMapper={writable:!0,value:function value(){return n.getMapper(e)}},t.getCollection={writable:!0,value:function value(){return n.getCollection(e)}},Object.create(this,t)},cachedFind:fe,cachedFindAll:fe,cacheFind:function cacheFind(e,t,n,i){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.get(e,t)}},cacheFindAll:function cacheFindAll(e,t,n,i){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.filter(e,d.fromJson(t))}},clear:function clear(){var e=this,t={};return d.forOwn(this._collections,function(n,i){t[i]=n.removeAll(),e._completedQueries[i]={}}),t},create:function create(e,t,n){var i=this;return n||(n={}),Container.prototype.create.call(this,e,t,n).then(function(t){return i._end(e,t,n)})},createMany:function createMany(e,t,n){var i=this;return n||(n={}),Container.prototype.createMany.call(this,e,t,n).then(function(t){return i._end(e,t,n)})},defineMapper:function defineMapper(e,t){var n=this,i=Container.prototype.defineMapper.call(n,e,t);n._pendingQueries[e]={},n._completedQueries[e]={},i.relationList||Object.defineProperty(i,"relationList",{value:[]});var r={_added:{},datastore:n,mapper:i};t&&"onConflict"in t&&(r.onConflict=t.onConflict);var o=n._collections[e]=new n.collectionClass(null,r),a=(i.schema||{}).properties||{};return d.forOwn(a,function(e,t){e.indexed&&o.createIndex(t)}),o.createIndex("addedTimestamps",["$"],{fieldGetter:function fieldGetter(e){return o._added[o.recordId(e)]}}),o.on("all",function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];n._onCollectionEvent.apply(n,[e].concat(i))}),i},destroy:function destroy(e,t,n){var i=this;return n||(n={}),Container.prototype.destroy.call(this,e,t,n).then(function(r){var o=i.getCollection(e).remove(t,n);return n.raw?r.data=o:r=o,delete i._pendingQueries[e][t],delete i._completedQueries[e][t],r})},destroyAll:function destroyAll(e,t,n){var i=this;return n||(n={}),Container.prototype.destroyAll.call(this,e,t,n).then(function(r){var o=i.getCollection(e).removeAll(t,n);n.raw?r.data=o:r=o;var a=i.hashQuery(e,t,n);return delete i._pendingQueries[e][a],delete i._completedQueries[e][a],r})},eject:function eject(e,t,n){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(e,t,n)},ejectAll:function ejectAll(e,t,n){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(e,t,n)},find:function find(e,t,n){var i=this;n||(n={});var r=this.getMapper(e),o=this._pendingQueries[e][t],a=void 0===n.usePendingFind?this.usePendingFind:n.usePendingFind;if(d._(n,r),o&&(d.isFunction(a)?a.call(this,e,t,n):a))return o;var s=this.cachedFind(e,t,n);return n.force||!s?(this._pendingQueries[e][t]=Container.prototype.find.call(this,e,t,n)).then(function(r){return delete i._pendingQueries[e][t],r=i._end(e,r,n),i.cacheFind(e,r,t,n),r},function(n){return delete i._pendingQueries[e][t],d.reject(n)}):d.resolve(s)},findAll:function findAll(e,t,n){var i=this;n||(n={});var r=this.getMapper(e),o=this.hashQuery(e,t,n),a=this._pendingQueries[e][o],s=void 0===n.usePendingFindAll?this.usePendingFindAll:n.usePendingFindAll;if(d._(n,r),a&&(d.isFunction(s)?s.call(this,e,t,n):s))return a;var c=this.cachedFindAll(e,o,n);return n.force||!c?(this._pendingQueries[e][o]=Container.prototype.findAll.call(this,e,t,n)).then(function(t){return delete i._pendingQueries[e][o],t=i._end(e,t,n),i.cacheFindAll(e,t,o,n),t},function(t){return delete i._pendingQueries[e][o],d.reject(t)}):d.resolve(c)},getCollection:function getCollection(e){var t=this._collections[e];if(!t)throw d.err("SimpleStore#getCollection",e)(404,"collection");return t},hashQuery:function hashQuery(e,t,n){return d.toJson(t||{})},inject:function inject(e,t,n){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(e,t,n)},remove:function remove(e,t,n){var i=this.getCollection(e).remove(t,n);return i&&this.removeRelated(e,[i],n),i},removeAll:function removeAll(e,t,n){t&&Object.keys(t).length?this._completedQueries[e][this.hashQuery(e,t,n)]=void 0:this._completedQueries[e]={};var i=this.getCollection(e).removeAll(t,n);return i.length&&this.removeRelated(e,i,n),i},removeRelated:function removeRelated(e,t,i){var r=this;d.isArray(t)||(t=[t]),d.forEachRelation(this.getMapper(e),i,function(e,i){t.forEach(function(t){var o=void 0,a=void 0;if(!e.foreignKey||"hasOne"!==e.type&&"hasMany"!==e.type?"hasMany"===e.type&&e.localKeys?a={where:n({},e.getRelation().idAttribute,{in:d.get(t,e.localKeys)})}:"hasMany"===e.type&&e.foreignKeys?a={where:n({},e.foreignKeys,{contains:e.getForeignKey(t)})}:"belongsTo"===e.type&&(o=r.remove(e.relation,e.getForeignKey(t),i)):a=n({},e.foreignKey,e.getForeignKey(t)),a&&(o=r.removeAll(e.relation,a,i)),o){if(d.isArray(o)&&!o.length)return;"hasOne"===e.type&&(o=o[0]),e.setLocalField(t,o)}})})},update:function update(e,t,n,i){var r=this;return i||(i={}),Container.prototype.update.call(this,e,t,n,i).then(function(t){return r._end(e,t,i)})},updateAll:function updateAll(e,t,n,i){var r=this;return i||(i={}),Container.prototype.updateAll.call(this,e,t,n,i).then(function(t){return r._end(e,t,i)})},updateMany:function updateMany(e,t,n){var i=this;return n||(n={}),Container.prototype.updateMany.call(this,e,t,n).then(function(t){return i._end(e,t,n)})}};ue.forEach(function(e){pe[e]=function(t){for(var n,i=arguments.length,r=Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return(n=this.getCollection(t))[e].apply(n,r)}});var ve=Container.extend(pe),ge="LinkedCollection",ye=M.extend({constructor:LinkedCollection,_addMeta:function _addMeta(e,t){this._added[this.recordId(e)]=t,d.isFunction(e._set)&&e._set("$",t)},_clearMeta:function _clearMeta(e){delete this._added[this.recordId(e)],d.isFunction(e._set)&&e._set("$")},_onRecordEvent:function _onRecordEvent(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];M.prototype._onRecordEvent.apply(this,t);var i=t[0];d.isString(i)&&0===i.indexOf("change")&&this.updateIndexes(t[1])},add:function add(e,t){var n=this,i=this.mapper,r=(new Date).getTime(),o=d.isObject(e)&&!d.isArray(e);return o&&(e=[e]),e=M.prototype.add.call(this,e,t),i.relationList.length&&e.length&&i.relationList.forEach(function(t){t.addLinkedRecords(e)}),e.forEach(function(e){return n._addMeta(e,r)}),o?e[0]:e},remove:function remove(e,t){var n=this.mapper,i=M.prototype.remove.call(this,e,t);return i&&this._clearMeta(i),n.relationList.length&&i&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,[i])}),i},removeAll:function removeAll(e,t){var n=this.mapper,i=M.prototype.removeAll.call(this,e,t);return i.forEach(this._clearMeta,this),n.relationList.length&&i.length&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,i)}),i}}),me={unlinkOnDestroy:!0},Ae={constructor:DataStore,defineMapper:function defineMapper(e,t){var n=this,i=ve.prototype.defineMapper.call(n,e,t),r=i.idAttribute,o=this.getCollection(e);return i.relationList.forEach(function(e){var t=e.relation,a=e.localField,s="links."+a,c=e.foreignKey,l=e.type,u={index:c},p=void 0,v=function getter(){return this._get(s)};if("belongsTo"===l){o.indexes[c]||o.createIndex(c),p={get:v,set:function set(l){var p=this._get(s);if(l===p)return p;var v=d.get(this,r),g=e.getInverse(i);if(p&&g&&this.removeInverseRelation(p,v,g,r),l){var y=e.getRelation().idAttribute,m=d.get(l,y);void 0!==m&&this._get("$")&&(l=n.get(t,m)||l),h(this,a,l),f(this,c,m),o.updateIndex(this,u),g&&this.setupInverseRelation(l,v,g,r)}else h(this,a,void 0);return l}};var g=Object.getOwnPropertyDescriptor(i.recordClass.prototype,c);g||(g={enumerable:!0});var y=g.get;g.get=function(){return y?y.call(this):this._get("props."+c)};var m=g.set;g.set=function(s){var l=this;m&&m.call(this,s);var p=d.get(this,a),v=d.get(this,r),g=e.getInverse(i),y=p?d.get(p,e.getRelation().idAttribute):void 0;if(p&&void 0!==y&&y!==s)if("hasOne"===g.type)h(p,g.localField,void 0);else if("hasMany"===g.type){var A=d.get(p,g.localField);void 0===v?d.remove(A,function(e){return e===l}):d.remove(A,function(e){return e===l||v===d.get(e,r)})}if(f(this,c,s),o.updateIndex(this,u),void 0===s||null===s)void 0!==y&&d.set(this,a,void 0);else if(this._get("$")){var b=n.get(t,s);b&&d.set(this,a,b)}},Object.defineProperty(i.recordClass.prototype,c,g)}else if("hasMany"===l){var A=e.localKeys,b=e.foreignKeys;n._collections[t]&&c&&!n.getCollection(t).indexes[c]&&n.getCollection(t).createIndex(c),p={get:function get(){return v.call(this)||this._set(s,[]),v.call(this)},set:function set(o){var l=this;o&&!d.isArray(o)&&(o=[o]);var p=d.get(this,r),v=e.getRelation().idAttribute,g=e.getInverse(i),y=g.localField,m=this._get(s)||[],O=[],_={};if(o&&o.forEach(function(e){var i=d.get(e,v),r=d.get(e,y);if(r&&r!==l){var o=d.get(r,a);void 0===i?d.remove(o,function(t){return t===e}):d.remove(o,function(t){return t===e||i===d.get(t,v)})}void 0!==i&&(l._get("$")&&(e=n.get(t,i)||e),_[i]=e),O.push(e)}),c)m.forEach(function(e){var i=d.get(e,v);(void 0===i&&-1===O.indexOf(e)||void 0!==i&&!(i in _))&&(o&&(f(e,c,void 0),n.getCollection(t).updateIndex(e,u)),h(e,y,void 0))}),O.forEach(function(e){f(e,c,p),n.getCollection(t).updateIndex(e,u),h(e,y,l)});else if(A){var x=O.map(function(e){return d.get(e,v)}).filter(function(e){return void 0!==e});d.set(this,A,x),g.foreignKeys&&(m.forEach(function(e){var t=d.get(e,v);if(void 0===t&&-1===O.indexOf(e)||void 0!==t&&!(t in _)){var n=d.get(e,y)||[];void 0===p?d.remove(n,function(e){return e===l}):d.remove(n,function(e){return e===l||p===d.get(e,r)})}}),O.forEach(function(e){var t=d.get(e,y);void 0===p?d.noDupeAdd(t,l,function(e){return e===l}):d.noDupeAdd(t,l,function(e){return e===l||p===d.get(e,r)})}))}else b&&(m.forEach(function(e){var t=d.get(e,b)||[];d.remove(t,function(e){return p===e});var n=d.get(e,y);void 0===p?d.remove(n,function(e){return e===l}):d.remove(n,function(e){return e===l||p===d.get(e,r)})}),O.forEach(function(e){var t=d.get(e,b)||[];d.noDupeAdd(t,p,function(e){return p===e});var n=d.get(e,y);void 0===p?d.noDupeAdd(n,l,function(e){return e===l}):d.noDupeAdd(n,l,function(e){return e===l||p===d.get(e,r)})}));return this._set(s,O),O}}}else"hasOne"===l&&(n._collections[t]&&c&&!n.getCollection(t).indexes[c]&&n.getCollection(t).createIndex(c),p={get:v,set:function set(o){var l=this._get(s);if(o===l)return l;var p=e.getInverse(i).localField;if(l&&(f(l,c,void 0),n.getCollection(t).updateIndex(l,u),h(l,p,void 0)),o){var v=d.get(o,e.getRelation().idAttribute);void 0!==v&&(o=n.get(t,v)||o),h(this,a,o),f(o,c,d.get(this,r)),n.getCollection(t).updateIndex(o,u),h(o,p,this)}else h(this,a,void 0);return o}});if(p){if(p.enumerable=void 0!==e.enumerable&&e.enumerable,e.get){var O=p.get;p.get=function(){var t=this;return e.get(e,this,function(){for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];return O.apply(t,n)})}}if(e.set){var _=p.set;p.set=function(t){var n=this;return e.set(e,this,t,function(e){return _.call(n,void 0===e?t:e)})}}Object.defineProperty(i.recordClass.prototype,a,p)}}),i},destroy:function destroy(e,t,n){var i=this;return n||(n={}),ve.prototype.destroy.call(this,e,t,n).then(function(t){var r=void 0;if((r=n.raw?t.data:t)&&i.unlinkOnDestroy){var o=d.plainCopy(n);o.withAll=!0,d.forEachRelation(i.getMapper(e),o,function(e){d.set(r,e.localField,void 0)})}return t})},destroyAll:function destroyAll(e,t,n){var i=this;return n||(n={}),ve.prototype.destroyAll.call(this,e,t,n).then(function(t){var r=void 0;if((r=n.raw?t.data:t)&&r.length&&i.unlinkOnDestroy){var o=d.plainCopy(n);o.withAll=!0,d.forEachRelation(i.getMapper(e),o,function(e){r.forEach(function(t){d.set(t,e.localField,void 0)})})}return t})}},be=ve.extend(Ae),Oe={full:"3.0.1",major:3,minor:0,patch:1};e.version=Oe,e.Collection=M,e.Component=p,e.Container=Container,e.DataStore=be,e.Index=Index,e.LinkedCollection=ye,e.Mapper=se,e.Query=O,e.Record=j,e.Schema=X,e.Settable=Settable,e.SimpleStore=ve,e.utils=d,e.belongsTo=x,e.hasMany=C,e.hasOne=w,e.belongsToType="belongsTo",e.hasManyType="hasMany",e.hasOneType="hasOne",Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=js-data.min.map