/*
 * jQuery Spellchecker - v0.1.0 - 2012-10-20
 * https://github.com/badsyntax/jquery-spellchecker
 * Copyright (c) 2012 Richard Willis; Licensed MIT
 */
(function(e,t){var n={lang:"en",engine:{path:"spellchecker.php",driver:"PSpell"},local:{requestError:"There was an error processing the request.",ignoreWord:"Ignore word",ignoreAll:"Ignore all",ignoreForever:"Add to dictionary",loading:"Loading..."},suggestBox:{numWords:5,position:"above",offset:2},incorrectWords:{container:"body"}},r="spellchecker";Function.prototype.bind||(Function.prototype.bind=function(e){return t.proxy(this,e)});var i=function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},s=function(){this._handlers={}};s.prototype={on:function(e,n){this._handlers[e]||(this._handlers[e]=t.Callbacks()),this._handlers[e].add(n)},trigger:function(e){if(this._handlers[e]){var t=Array.prototype.slice.call(arguments,1);this._handlers[e].fireWith(this,t)}},handler:function(e){return function(t){this.trigger(e,t)}.bind(this)}};var o=function(e){s.call(this),this.config=e,this.createBox(),this.bindEvents()};i(o,s),o.prototype.onSelectWord=function(e){e.stopPropagation();var n=t(e.currentTarget),r=t.trim(n.text());this.trigger("select.word",e,r,n)};var u=function(e){o.apply(this,arguments)};i(u,o),u.prototype.bindEvents=function(){this.container.on("click","a",this.onSelectWord.bind(this))},u.prototype.createBox=function(){this.container=t(['<div class="'+r+'-incorrectwords">',"</div>"].join("")).appendTo(this.config.incorrectWords.container)},u.prototype.addWords=function(e){e=t.grep(e,function(n,r){return r===t.inArray(n,e)});var n=t.map(e,function(e){return'<a href="#">'+e+"</a>"}).join("");this.container.html(n).show()},u.prototype.loading=function(e){this.container.html(e?this.config.local.loading:"")};var a=function(e,t,n){s.call(this),this.config=e,this.parser=t,this.element=n,this.bindEvents()};i(a,s),a.prototype.bindEvents=function(){this.element.on("click","."+r+"-word-highlight",this.onSelectWord.bind(this))},a.prototype.addWords=function(e){var t=this.parser.highlightWords(e);this.element.html(t)},a.prototype.loading=function(){},a.prototype.onSelectWord=function(e){e.preventDefault(),e.stopPropagation();var n=t(e.currentTarget),r=t.trim(n.data("word"));this.trigger("select.word",e,r,n)};var f=function(e,t){this.element=t,this.body=this.element[0].nodeName==="BODY"?this.element:"body",o.apply(this,arguments)};i(f,o),f.prototype.bindEvents=function(){var e="click."+r;this.container.on(e,this.onContainerClick.bind(this)),this.container.on(e,".ignore-word",this.handler("ignore.word")),this.container.on(e,".ignore-all",this.handler("ignore.all")),this.container.on(e,".ignore-forever",this.handler("ignore.forever")),this.container.on(e,".words a",this.onSelectWord.bind(this)),t("html").on(e,this.onWindowClick.bind(this)),this.element[0].nodeName==="BODY"&&this.element.parent().on(e,this.onWindowClick.bind(this))},f.prototype.createBox=function(){var e=this.config.local;this.container=t(['<div class="'+r+'-suggestbox">',' <div class="footer">','   <a href="#" class="ignore-word">'+e.ignoreWord+"</a>",'   <a href="#" class="ignore-all">'+e.ignoreAll+"</a>",'   <a href="#" class="ignore-forever">'+e.ignoreForever+"</a>"," </div>","</div>"].join("")).appendTo(this.body),this.words=t(['<div class="words">',"</div>"].join("")).prependTo(this.container),this.loadingMsg=t(['<div class="loading">',this.config.local.loading,"</div>"].join("")),this.footer=this.container.find(".footer").hide()},f.prototype.addWords=function(e){var n=t.map(e,function(e){return'<a href="#">'+e+"</a>"}).slice(0,this.config.suggestBox.numWords).join("");n||(n="<em>(No suggestions)</em>"),this.words.html(n)},f.prototype.loadSuggestedWords=function(e,n,r){this.wordElement=t(r),this.loading(!0),e(n,this.onGetWords.bind(this))},f.prototype.loading=function(e){this.footer.hide(),this.open(),this.words.html(e?this.loadingMsg:""),this.position()},f.prototype.position=function(){var n=t(e),r=this.wordElement.data("firstElement")||this.wordElement,i=r.offset(),s=this.config.suggestBox.offset,o=this.container.outerHeight(),u=i.top-o-s,a=i.top+r.outerHeight()+s,f=i.left,l;this.config.suggestBox.position==="below"?(l=a,n.height()+n.scrollTop()<a+o&&(l=u)):l=u,this.container.css({top:l,left:f})},f.prototype.open=function(){this.position(),this.container.fadeIn(180)},f.prototype.close=function(){this.container.fadeOut(100,function(){this.footer.hide()}.bind(this))},f.prototype.detach=function(){this.container=this.container.detach()},f.prototype.reattach=function(){this.container.appendTo(this.body)},f.prototype.onGetWords=function(e){this.loading(!1),this.addWords(e),this.footer.show(),this.position()},f.prototype.onContainerClick=function(e){e.stopPropagation()},f.prototype.onWindowClick=function(e){this.close()};var l=function(e){this.config=e,this.defaultConfig={url:e.engine.path,type:"POST",dataType:"json",cache:!1,data:{lang:e.lang,driver:e.engine.driver},error:function(){alert(e.local.requestError)}.bind(this)}};l.prototype.makeRequest=function(e){var n=t.extend(!0,{},this.defaultConfig);return t.ajax(t.extend(!0,n,e))},l.prototype.checkWords=function(e,t){return this.makeRequest({data:{action:"get_incorrect_words",text:e},success:t})},l.prototype.getSuggestedWords=function(e,t){return this.makeRequest({data:{action:"get_suggestions",word:e},success:t})};var c=function(e){this.element=e};c.prototype.clean=function(e){var n="<[^>]+>",r="^[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]+[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]$|\\n|\\t|\\s{2,}";return e=e.replace(new RegExp(n,"g"),""),e=e.replace(new RegExp(r,"g")," "),t.trim(e)};var h=function(){c.apply(this,arguments)};i(h,c),h.prototype.getText=function(){return this.clean(this.element.val())},h.prototype.replaceWordInText=function(e,t,n){return e.replace(new RegExp("([^a-zA-Z\\u00A1-\\uFFFF]?)("+t+")([^a-zA-Z\\u00A1-\\uFFFF]?)","g"),"$1"+n+"$3").replace(new RegExp("^("+t+")([^a-zA-Z\\u00A1-\\uFFFF])","g"),n+"$2").replace(new RegExp("([^a-zA-Z\\u00A1-\\uFFFF])("+t+")$","g"),"$1"+n)},h.prototype.replaceWord=function(e,t){var n=this.element.val(),r=this.replaceWordInText(n,e,t);this.element.val(r)};var p=function(){c.apply(this,arguments)};i(p,c),p.prototype.getText=function(){var e=this.element.clone().find('[class^="spellchecker-"]').remove().end(),t=this.element.text();return this.clean(t)},p.prototype.replaceText=function(t,n){e.findAndReplaceDOMText(t,this.element[0],n)},p.prototype.replaceWord=function(n,r){e.findAndReplaceDOMText.revert();var i=r,s,o,u,a=new RegExp("\\b"+n+"\\b","g");this.replaceText(a,function(e,t){return t!==u&&(u=t,r=i,s=""),o=r.substring(0,e.length),r=r.substring(e.length),s+=e,s===n&&r.length>0&&(o+=r),document.createTextNode(o||"")}),this.incorrectWords=t.map(this.incorrectWords,function(e){return e===n?null:e}),this.highlightWords(this.incorrectWords)},p.prototype.highlightWords=function(e){if(!e.length)return;this.incorrectWords=e;var n=new RegExp("\\b"+e.join("|")+"\\b","g"),i,s;this.replaceText(n,function(n,o){var u=t("<span />",{"class":r+"-word-highlight","data-word":e[o]});return u.text(n),o!==i&&(i=0,s=u),u.data("firstElement",s),u[0]})};var d=function(e,r){s.call(this),this.element=t(e).attr("spellcheck","false"),this.config=t.extend(!0,n,r),this.setupEngine(),this.setupParser(),this.setupSuggestBox(),this.setupIncorrectWords(),this.bindEvents()};i(d,s),d.prototype.setupEngine=function(){this.engine=new l(this.config)},d.prototype.setupSuggestBox=function(){this.suggestBox=new f(this.config,this.element)},d.prototype.setupIncorrectWords=function(){this.incorrectWords=this.config.parser==="html"?new a(this.config,this.parser,this.element):new u(this.config,this.parser,this.element)},d.prototype.setupParser=function(){this.parser=this.config.parser==="html"?new p(this.element):new h(this.element)},d.prototype.bindEvents=function(){this.on("check.fail",this.onCheckFail.bind(this)),this.suggestBox.on("ignore.word",this.onIgnoreWord.bind(this)),this.suggestBox.on("ignore.all",this.onIgnoreAll.bind(this)),this.suggestBox.on("ignore.forever",this.onIgnoreForever.bind(this)),this.suggestBox.on("select.word",this.onSuggestedWordSelect.bind(this)),this.incorrectWords.on("select.word",this.onIncorrectWordSelect.bind(this))},d.prototype.check=function(){this.incorrectWords.loading(!0);var e=this.parser.getText();this.engine.checkWords(e,this.onCheckWords.bind(this))},d.prototype.showSuggestedWords=function(e,t){var n=this.engine.getSuggestedWords.bind(this.engine);this.suggestBox.loadSuggestedWords(n,e,t)},d.prototype.onCheckWords=function(e){this.incorrectWords.loading(!1);var t=e.data,n=t.length?"fail":"success";this.trigger("check."+n,t)},d.prototype.onCheckFail=function(e){this.suggestBox.detach(),this.incorrectWords.addWords(e),this.suggestBox.reattach()},d.prototype.onSuggestedWordSelect=function(e,t,n){e.preventDefault(),this.suggestBox.close(),this.suggestBox.detach(),this.parser.replaceWord(this.incorrectWord,t),this.suggestBox.reattach()},d.prototype.onIgnoreWord=function(){alert("Ignore word")},d.prototype.onIgnoreAll=function(){alert("Ignore all")},d.prototype.onIgnoreForever=function(){alert("Ignore forever")},d.prototype.onIncorrectWordSelect=function(e,t,n){e.preventDefault(),this.incorrectWord=t,this.incorrectWordElement=n,this.showSuggestedWords(t,n)},t.SpellChecker=d})(this,jQuery),window.findAndReplaceDOMText=function(){function e(e,r,s){var o,u,a=[],f=t(r),l=i(s);if(!f)return;if(e.global)while(o=e.exec(f)){if(!o[0])throw"findAndReplaceDOMText cannot handle zero-length matches";a.push([e.lastIndex-o[0].length,e.lastIndex,o])}else{o=f.match(e),u=f.indexOf(o[0]);if(!o[0])throw"findAndReplaceDOMText cannot handle zero-length matches";a.push([u,u+o[0].length,o])}a.length&&n(r,a,l)}function t(e){if(e.nodeType===3)return e.data;var n="";if(e=e.firstChild)do n+=t(e);while(e=e.nextSibling);return n}function n(e,t,n){var r,i,s,o,u,a,f=[],l=0,c=e,h=t.shift(),p=0;e:for(;;){c.nodeType===3&&(!o&&c.length+l>=h[1]?(o=c,a=h[1]-l):s&&f.push(c),!s&&c.length+l>h[0]&&(s=c,u=h[0]-l),l+=c.length);if(s&&o){c=n({startNode:s,startNodeIndex:u,endNode:o,endNodeIndex:a,innerNodes:f,match:h[2],matchIndex:p}),l-=o.length-a,s=null,o=null,f=[],h=t.shift(),p++;if(!h)break}else if(c.firstChild||c.nextSibling){c=c.firstChild||c.nextSibling;continue}for(;;){if(c.nextSibling){c=c.nextSibling;break}if(c.parentNode===e)break e;c=c.parentNode}}}function i(e){r=[];var t;if(typeof e!="function"){var n=e.nodeType?e:document.createElement(e);t=function(e){var t=document.createElement("div"),r;return t.innerHTML=n.outerHTML||(new window.XMLSerializer).serializeToString(n),r=t.firstChild,e&&r.appendChild(document.createTextNode(e)),r}}else t=e;return function(n){var i=n.startNode,s=n.endNode,o=n.matchIndex,u,a;if(i===s){var f=i;n.startNodeIndex>0&&(u=document.createTextNode(f.data.substring(0,n.startNodeIndex)),f.parentNode.insertBefore(u,f));var l=t(n.match[0],o);return f.parentNode.insertBefore(l,f),n.endNodeIndex<f.length&&(a=document.createTextNode(f.data.substring(n.endNodeIndex)),f.parentNode.insertBefore(a,f)),f.parentNode.removeChild(f),r.push(function(){var e=l.parentNode;e.insertBefore(l.firstChild,l),e.removeChild(l),e.normalize()}),l}u=document.createTextNode(i.data.substring(0,n.startNodeIndex)),a=document.createTextNode(s.data.substring(n.endNodeIndex));var c=t(i.data.substring(n.startNodeIndex),o),h=[];for(var p=0,d=n.innerNodes.length;p<d;++p){var v=n.innerNodes[p],m=t(v.data,o);v.parentNode.replaceChild(m,v),h.push(m)}var g=t(s.data.substring(0,n.endNodeIndex),o);return i.parentNode.insertBefore(u,i),i.parentNode.insertBefore(c,i),i.parentNode.removeChild(i),s.parentNode.insertBefore(g,s),s.parentNode.insertBefore(a,s),s.parentNode.removeChild(s),r.push(function(){h.unshift(c),h.push(g);for(var e=0,t=h.length;e<t;++e){var n=h[e],r=n.parentNode;r.insertBefore(n.firstChild,n),r.removeChild(n),r.normalize()}}),g}}var r;return e.revert=function(){for(var t=0,n=r.length;t<n;++t)r[t]();r=[]},e}();