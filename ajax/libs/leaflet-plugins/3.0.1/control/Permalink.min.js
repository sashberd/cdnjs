L.Control.Permalink=L.Control.extend({includes:L.Mixin.Events,options:{position:"bottomleft",useAnchor:!0,useLocation:!1,useLocalStorage:!1,text:"Permalink"},initialize:function(t){L.Util.setOptions(this,t),this._params={},this._set_urlvars(),this.on("update",this._set_center,this);for(var i in this)"string"==typeof i&&0===i.indexOf("initialize_")&&this[i]()},onAdd:function(t){if(this._container=L.DomUtil.create("div","leaflet-control-attribution leaflet-control-permalink"),L.DomEvent.disableClickPropagation(this._container),this._map=t,this._href=L.DomUtil.create("a",null,this._container),this._href.innerHTML=this.options.text,t.on("moveend",this._update_center,this),this.fire("update",{params:this._params}),this._update_center(),this.options.useAnchor&&"onhashchange"in window){var i=this,e=window.onhashchange;window.onhashchange=function(){if(i._set_urlvars(),e)return e()}}return this.fire("add",{map:t}),this._container},_update_center:function(){if(this._map){var t=this._round_point(this._map.getCenter());this._update({zoom:String(this._map.getZoom()),lat:String(t.lat),lon:String(t.lng)})}},_update_href:function(){var t=L.Util.getParamString(this._params),i="?";this.options.useAnchor&&(i="#");var e=this._url_base+i+t.slice(1);return this._href&&this._href.setAttribute("href",e),this.options.useLocation&&location.replace("#"+t.slice(1)),this.options.useLocalStorage&&window.localStorage.setItem("paramsTemp",t.slice(1)),e},_round_point:function(t){var i=this._map.getBounds(),e=this._map.getSize(),r=i.getNorthEast(),n=i.getSouthWest(),a=function(t,i){if(0===i)return t;for(var e=1;i<1&&i>-1;)t*=10,i*=10,e*=10;return Math.floor(t)/e};return t.lat=a(t.lat,(r.lat-n.lat)/e.y),t.lng=a(t.lng,(r.lng-n.lng)/e.x),t},_update:function(t){for(var i in t)t.hasOwnProperty(i)&&(null!==t[i]&&void 0!==t[i]?this._params[i]=t[i]:delete this._params[i]);this._update_href()},_set_urlvars:function(){function t(t,i){for(var e in t)if(t.hasOwnProperty(e)&&t[e]!==i[e])return!1;return!0}var i;this.options.useAnchor?(i=L.UrlUtil.queryParse(L.UrlUtil.hash()),this._url_base=window.location.href.split("#")[0]):(i=L.UrlUtil.queryParse(L.UrlUtil.query()),this._url_base=window.location.href.split("#")[0].split("?")[0]),this.options.useLocalStorage&&(i=null!==(i=window.localStorage.getItem("paramsTemp"))?L.UrlUtil.queryParse(i):{}),t(i,this._params)&&t(this._params,i)||(this._params=i,this._update_href(),this.fire("update",{params:this._params}))},_set_center:function(t){var i=t.params;void 0!==i.zoom&&void 0!==i.lat&&void 0!==i.lon&&this._map.setView(new L.LatLng(i.lat,i.lon),i.zoom)}}),L.UrlUtil={queryParse:function(t){var i={},e="&";-1!==t.search("&amp;")&&(e="&amp;");for(var r=t.split(e),n=0;n<r.length;n++){var a=r[n].split("=");if(2===a.length)try{i[a[0]]=decodeURIComponent(a[1])}catch(t){i[a[0]]=a[1]}}return i},query:function(){var t=window.location.href.split("#")[0],i=t.indexOf("?");return i<0?"":t.slice(i+1)},hash:function(){return window.location.hash.slice(1)},updateParamString:function(t,i){var e=L.UrlUtil.queryParse(t);for(var r in i)i.hasOwnProperty(r)&&(e[r]=i[r]);return L.Util.getParamString(e).slice(1)}};